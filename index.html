<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›ä½œè€…åå¹´å˜åŒ–æ€»ç»“è¡¨</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@gradio/lite/dist/static/gradio-lite.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gradio/lite/dist/static/style.css" />
    <style>
        body { background-color: #F4F1EA; margin: 0; }
        /* ç¡®ä¿åŠ è½½åŠ¨ç”»å±…ä¸­ */
        gradio-lite { min-height: 100vh; }
    </style>
</head>
<body>
    <gradio-lite>
        <gradio-requirements>
            pillow
        </gradio-requirements>

        <gradio-file name="app.py" entrypoint>
import gradio as gr
from PIL import Image, ImageDraw, ImageFont
import datetime
import textwrap
import io
import os
import urllib.request

# --- é…ç½®å‚æ•° ---
YEARS = range(2016, 2026)
YEARS_LEFT = YEARS[:5]
YEARS_RIGHT = YEARS[5:]
COLUMNS = 2

COLOR_BG_LIGHT = '#F4F1EA'
COLOR_TEXT_DARK = '#2D4739'
COLOR_TITLE_DARK = '#121619'
COLOR_ACCENT_LINE = '#BCB382'
COLOR_HIGHLIGHT = '#47340C'

# --- å­—ä½“å¤„ç†é€»è¾‘ ---
# è¯·å°†ä¸‹æ–¹é“¾æ¥ä¸­çš„ FrozenPenguin æ›¿æ¢ä¸ºæ‚¨çœŸå®çš„ GitHub ç”¨æˆ·å
FONT_URL = "https://raw.githubusercontent.com/c-nancy/words/master/scripts/font.ttf"
FONT_PATH = "font.ttf"

def get_font(size):
    if not os.path.exists(FONT_PATH):
        try:
            # åœ¨æµè§ˆå™¨ä¸­é™é»˜ä¸‹è½½å­—ä½“æ–‡ä»¶
            urllib.request.urlretrieve(FONT_URL, FONT_PATH)
        except:
            return ImageFont.load_default()
    try:
        return ImageFont.truetype(FONT_PATH, size)
    except:
        return ImageFont.load_default()

def generate_summary_image(*args):
    base_info = {
        "title": args[0], "creator": args[1], "writer": args[2], "date": args[3]
    }
    creative_records = {}
    data_start_index = 4
    for i, year in enumerate(YEARS):
        start = data_start_index + i * 4
        creative_records[year] = {
            "cp_work": args[start],
            "style_excerpt": args[start + 1],
            "major_impact": args[start + 2],
            "reflection": args[start + 3],
        }

    W, MARGIN, GUTTER = 1600, 50, 40
    COLUMN_WIDTH = (W - 2 * MARGIN - GUTTER) // COLUMNS
    TEXT_WIDTH = COLUMN_WIDTH - 40

    # è·å–ä¸åŒå°ºå¯¸å­—ä½“
    f_title = get_font(55)
    f_year = get_font(30)
    f_header = get_font(25)
    f_text = get_font(20)

    line_height = 32

    def get_text_height(text, font, max_width):
        if not text: return line_height
        # æµè§ˆå™¨ç¯å¢ƒä¸‹çš„å­—ç¬¦å®½åº¦ä¼°ç®—
        chars_per_line = int(max_width / 20)
        lines = textwrap.wrap(text, width=chars_per_line, replace_whitespace=False)
        return len(lines) * line_height + 15

    def calculate_year_height(year):
        record = creative_records[year]
        h = 80 # æ ‡é¢˜ç©ºé—´
        h += get_text_height(record["cp_work"], f_text, TEXT_WIDTH) + 40
        h += get_text_height(record["style_excerpt"], f_text, TEXT_WIDTH) + 40
        h += get_text_height(record["major_impact"], f_text, TEXT_WIDTH) + 40
        h += get_text_height(record["reflection"], f_text, TEXT_WIDTH) + 40
        return h + 40

    H_left = sum(calculate_year_height(y) for y in YEARS_LEFT)
    H_right = sum(calculate_year_height(y) for y in YEARS_RIGHT)
    H = 250 + max(H_left, H_right)

    img = Image.new('RGB', (W, int(H)), color=COLOR_BG_LIGHT)
    draw = ImageDraw.Draw(img)

    # ç»˜åˆ¶é¡µçœ‰
    draw.text((W/2, 80), base_info['title'], fill=COLOR_TITLE_DARK, anchor="ms", font=f_title)
    draw.text((MARGIN, 150), f"å¡«è¡¨äºº: {base_info['writer']}", fill=COLOR_TEXT_DARK, font=f_text)
    draw.text((W/2, 150), f"å¡«å†™æ—¶é—´: {base_info['date']}", fill=COLOR_TEXT_DARK, anchor="mt", font=f_text)
    draw.text((W-MARGIN, 150), f"åˆ¶è¡¨äºº: {base_info['creator']}", fill=COLOR_TEXT_DARK, anchor="rt", font=f_text)
    draw.line((MARGIN, 180, W-MARGIN, 180), fill=COLOR_TITLE_DARK, width=2)

    def draw_col(years, x_start, y_start):
        y = y_start
        for year in years:
            rec = creative_records[year]
            draw.text((x_start, y), f"ğŸŒŸ ã€ {year} å¹´ åˆ›ä½œå°ç»“ ã€‘", fill=COLOR_HIGHLIGHT, font=f_year)
            y += 60
            for q, k in [("1. æœ¬å¹´æˆ‘åœ¨å†™ï¼š", "cp_work"), ("2. é£æ ¼æ®µè½ï¼š", "style_excerpt"),
                         ("3. é‡å¤§å½±å“ï¼š", "major_impact"), ("4. æ€»ç»“æ„Ÿæƒ³ï¼š", "reflection")]:
                draw.text((x_start, y), q, fill=COLOR_HIGHLIGHT, font=f_header)
                y += line_height
                txt = rec[k] or "(æš‚æ— å†…å®¹)"
                lines = textwrap.wrap(txt, width=int(TEXT_WIDTH/20), replace_whitespace=False)
                for line in lines:
                    draw.text((x_start + 10, y), line, fill=COLOR_TEXT_DARK, font=f_text)
                    y += line_height
                y += 20
            draw.line((x_start + 50, y, x_start + COLUMN_WIDTH - 50, y), fill=COLOR_ACCENT_LINE, width=1)
            y += 50

    draw_col(YEARS_LEFT, MARGIN, 220)
    draw_col(YEARS_RIGHT, MARGIN + COLUMN_WIDTH + GUTTER, 220)

    # ç»˜åˆ¶ä¸­çº¿
    mid_x = MARGIN + COLUMN_WIDTH + GUTTER // 2
    draw.line((mid_x, 220, mid_x, H - 50), fill=COLOR_TITLE_DARK, width=2)

    return img

with gr.Blocks(theme=gr.themes.Soft(primary_hue="stone")) as demo:
    gr.Markdown("# âœï¸ åˆ›ä½œè€…åå¹´å˜åŒ–æ€»ç»“è¡¨")

    all_inputs = []
    with gr.Tabs():
        with gr.TabItem("ğŸ“ åŸºç¡€ä¿¡æ¯"):
            t = gr.Textbox(value="åˆ›ä½œè€…åå¹´å˜åŒ–æ€»ç»“è¡¨", label="æ ‡é¢˜")
            c = gr.Textbox(value="å—æå†°é›•å¸ˆ", label="åˆ¶è¡¨äºº")
            w = gr.Textbox(label="å¡«è¡¨äºº", placeholder="æ‚¨çš„ç¬”å")
            d = gr.Textbox(value=datetime.date.today().strftime("%Yå¹´%mæœˆ%dæ—¥"), label="æ—¥æœŸ")
            all_inputs.extend([t, c, w, d])

        for year in YEARS:
            with gr.TabItem(f"{year}"):
                all_inputs.extend([
                    gr.Textbox(label="1. æœ¬å¹´æˆ‘åœ¨å†™ï¼š", lines=2),
                    gr.Textbox(label="2. æœ€èƒ½ä»£è¡¨æœ¬å¹´é£æ ¼çš„æ®µè½ï¼š", lines=5),
                    gr.Textbox(label="3. æœ¬å¹´å¯¹æˆ‘å½±å“æœ€å¤§çš„äº‹ï¼š", lines=2),
                    gr.Textbox(label="4. æœ¬å¹´åˆ›ä½œæ€»ç»“æ„Ÿæƒ³ï¼š", lines=3)
                ])

        with gr.TabItem("ğŸ–¼ï¸ å®Œæˆä¸å¯¼å‡º"):
            btn = gr.Button("ç‚¹å‡»ç”Ÿæˆé•¿å›¾", variant="primary")
            out = gr.Image(label="ç”Ÿæˆçš„å›¾ç‰‡ (å³é”®å¦å­˜ä¸º)", type="pil")

    gr.Markdown("--- \n ### ğŸ’¡ æç¤ºï¼šé¡µé¢åˆ·æ–°å†…å®¹ä¼šæ¶ˆå¤±ï¼Œè¯·æ³¨æ„å¤‡ä»½ã€‚")
    btn.click(generate_summary_image, inputs=all_inputs, outputs=out)

demo.launch()
        </gradio-file>
    </gradio-lite>
</body>
</html>