<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰µä½œè€…åå¹´è®ŠåŒ–ç¸½çµè¡¨</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@gradio/lite/dist/static/gradio-lite.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gradio/lite/dist/static/style.css" />
    <style>
        /* è¨­ç½®ç¶²é åŸºç¤èƒŒæ™¯è‰²èˆ‡ Python ä»£ç¢¼ä¸€è‡´ */
        body { background-color: #F4F1EA; margin: 0; padding: 20px; }
    </style>
</head>
<body>
    <gradio-lite>
        <gradio-requirements>
            pillow
        </gradio-requirements>

        <gradio-file name="app.py" entrypoint>
import gradio as gr
from PIL import Image, ImageDraw, ImageFont
import datetime
import textwrap
import io
import os

# --- é…ç½®åƒæ•¸ (2016-2025) ---
YEARS = range(2016, 2026)
YEARS_LEFT = YEARS[:5]
YEARS_RIGHT = YEARS[5:]
COLUMNS = 2

# --- é…è‰²æ–¹æ¡ˆ (èˆ‡ word.py ä¸€è‡´) ---
COLOR_BG_LIGHT = '#F4F1EA'
COLOR_TEXT_DARK = '#2D4739'
COLOR_TITLE_DARK = '#121619'
COLOR_ACCENT_LINE = '#BCB382'
COLOR_HIGHLIGHT = '#47340C'

def generate_summary_image(*args):
    """ç”Ÿæˆç¸½çµé•·åœ–çš„æ ¸å¿ƒé‚è¼¯"""
    base_info = {
        "title": args[0],
        "creator": args[1],
        "writer": args[2],
        "date": args[3]
    }

    creative_records = {}
    data_start_index = 4
    for i, year in enumerate(YEARS):
        start = data_start_index + i * 4
        creative_records[year] = {
            "cp_work": args[start],
            "style_excerpt": args[start + 1],
            "major_impact": args[start + 2],
            "reflection": args[start + 3],
        }

    W, MARGIN, GUTTER = 1600, 50, 40
    COLUMN_WIDTH = (W - 2 * MARGIN - GUTTER) // COLUMNS
    TEXT_WIDTH = COLUMN_WIDTH - 40

    # ç€è¦½å™¨ç’°å¢ƒä¸‹é»˜èªåŠ è¼‰ç³»çµ±å­—é«”æˆ– Default
    font_title = ImageFont.load_default()
    font_year = ImageFont.load_default()
    font_header = ImageFont.load_default()
    font_text = ImageFont.load_default()
    font_base = ImageFont.load_default()

    line_height = 30

    def get_text_height(text, font, max_width):
        if not text: return line_height
        chars_per_line = int(max_width / (20 * 0.9)) # ä¼°ç®—å¯¬åº¦
        lines = textwrap.wrap(text, width=chars_per_line, replace_whitespace=False)
        return len(lines) * line_height + 15

    def calculate_year_height(year):
        record = creative_records[year]
        h = 50 + 30 + 4 * line_height
        h += get_text_height(record["cp_work"], font_text, TEXT_WIDTH)
        h += get_text_height(record["style_excerpt"], font_text, TEXT_WIDTH)
        h += get_text_height(record["major_impact"], font_text, TEXT_WIDTH)
        h += get_text_height(record["reflection"], font_text, TEXT_WIDTH)
        return h + 120

    H_content = max(sum(calculate_year_height(y) for y in YEARS_LEFT),
                    sum(calculate_year_height(y) for y in YEARS_RIGHT))
    H = 250 + H_content

    img = Image.new('RGB', (W, H), color=COLOR_BG_LIGHT)
    draw = ImageDraw.Draw(img)

    y_cursor = 50
    draw.text((W / 2, y_cursor), base_info['title'], fill=COLOR_TITLE_DARK, anchor="ms")
    y_cursor += 70

    draw.text((MARGIN, y_cursor), f"å¡«è¡¨äºº: {base_info['writer']}", fill=COLOR_TEXT_DARK)
    draw.text((W / 2, y_cursor), f"å¡«å¯«æ™‚é–“: {base_info['date']}", fill=COLOR_TEXT_DARK, anchor="mt")
    draw.text((W - MARGIN, y_cursor), f"è£½è¡¨äºº: {base_info['creator']}", fill=COLOR_TEXT_DARK, anchor="rt")

    y_cursor += 50
    draw.line((MARGIN, y_cursor, W - MARGIN, y_cursor), fill=COLOR_TITLE_DARK, width=2)
    y_cursor += 40

    def draw_year_records(years_list, x_start, y_start_initial):
        y_cursor_col = y_start_initial
        for year in years_list:
            record = creative_records[year]
            draw.text((x_start, y_cursor_col + 5), f"ğŸŒŸ ã€ {year} å¹´ å‰µä½œå°çµ ã€‘", fill=COLOR_HIGHLIGHT)
            y_cursor_col += 80

            for question, key in [
                ("1. æœ¬å¹´æˆ‘åœ¨å¯«ï¼š", "cp_work"),
                ("2. æœ€èƒ½ä»£è¡¨æˆ‘æœ¬å¹´é¢¨æ ¼çš„æ®µè½æ˜¯ï¼š", "style_excerpt"),
                ("3. æœ¬å¹´å°æˆ‘å‰µä½œå½±éŸ¿æœ€å¤§çš„äº‹æ˜¯ï¼š", "major_impact"),
                ("4. æœ¬å¹´å‰µä½œçš„ç¸½çµæ„Ÿæƒ³æ˜¯ï¼š", "reflection")
            ]:
                draw.text((x_start, y_cursor_col), question, fill=COLOR_HIGHLIGHT)
                y_cursor_col += line_height
                content = record[key] or "(æš«ç„¡å…§å®¹)"
                lines = textwrap.wrap(content, width=int(TEXT_WIDTH/18), replace_whitespace=False)
                for line in lines:
                    draw.text((x_start + 10, y_cursor_col), line, fill=COLOR_TEXT_DARK)
                    y_cursor_col += line_height
                y_cursor_col += 20
            draw.line((x_start + 50, y_cursor_col - 10, x_start + COLUMN_WIDTH - 50, y_cursor_col - 10), fill=COLOR_ACCENT_LINE, width=1)
            y_cursor_col += 40

    draw_year_records(YEARS_LEFT, MARGIN, y_cursor)
    draw_year_records(YEARS_RIGHT, MARGIN + COLUMN_WIDTH + GUTTER, y_cursor)

    center_x = MARGIN + COLUMN_WIDTH + GUTTER / 2
    draw.line((center_x, y_cursor, center_x, H - 50), fill=COLOR_TEXT_DARK, width=2)

    return img

# Gradio UI ä½ˆå±€ (åŒæ­¥ word.py çš„çµæ§‹)
with gr.Blocks(
    title="å‰µä½œè€…åå¹´è®ŠåŒ–ç¸½çµè¡¨",
    css=f"body {{ background-color: {COLOR_BG_LIGHT}; }}",
    theme=gr.themes.Soft(primary_hue="stone", secondary_hue="gray")
) as demo:
    gr.Markdown(f"# <span style='color: {COLOR_TITLE_DARK};'>âœï¸ å‰µä½œè€…åå¹´è®ŠåŒ–ç¸½çµè¡¨</span>")
    all_inputs = []

    with gr.Tabs():
        with gr.TabItem("ğŸ“ åŸºç¤ä¿¡æ¯"):
            title_box = gr.Textbox(value="å‰µä½œè€…åå¹´è®ŠåŒ–ç¸½çµè¡¨", label="æ¨™é¡Œ")
            creator_box = gr.Textbox(value="å—æ¥µå†°é›•å¸«", label="è£½è¡¨äºº")
            writer_box = gr.Textbox(label="å¡«è¡¨äºº", placeholder="æ‚¨çš„åå­—")
            date_box = gr.Textbox(label="æ™‚é–“", value=datetime.date.today().strftime("%Yå¹´%mæœˆ%dæ—¥"))
            all_inputs.extend([title_box, creator_box, writer_box, date_box])

        for year in YEARS:
            with gr.TabItem(f"âœ’ï¸ {year} "):
                c1 = gr.Textbox(label="1. æœ¬å¹´æˆ‘åœ¨å¯«ï¼š", lines=2)
                c2 = gr.Textbox(label="2. é¢¨æ ¼æ®µè½ï¼š", lines=5)
                c3 = gr.Textbox(label="3. é‡å¤§å½±éŸ¿ï¼š", lines=2)
                c4 = gr.Textbox(label="4. ç¸½çµæ„Ÿæƒ³ï¼š", lines=3)
                all_inputs.extend([c1, c2, c3, c4])

        with gr.TabItem("ğŸ–¼ï¸ å®Œæˆèˆ‡å°å‡º"):
            btn = gr.Button("ç”Ÿæˆåå¹´ç¸½çµåœ–", variant="primary")
            output_image = gr.Image(label="åå¹´ç¸½çµ", type="pil")

    gr.Markdown("--- \n ### ğŸ’¡ èªªæ˜ï¼š\n 1. **æ•¸æ“šå®‰å…¨**ï¼šé é¢åˆ·æ–°æœƒå°è‡´å…§å®¹æ¸…ç©ºï¼Œè«‹åŠæ™‚å‚™ä»½ã€‚\n 2. **éœæ…‹é‹è¡Œ**ï¼šæœ¬é é¢å®Œå…¨åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­é‹è¡Œï¼Œç„¡éœ€ä¼ºæœå™¨ã€‚")
    btn.click(generate_summary_image, inputs=all_inputs, outputs=output_image)

demo.launch()
        </gradio-file>
    </gradio-lite>
</body>
</html>